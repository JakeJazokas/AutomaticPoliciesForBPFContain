# Automatic Policy Generation for BPFContain

This program allows for the automatic generation of security policies for [BPFContain](https://github.com/willfindlay/bpfcontain-rs) based on the traced operations of a given program. Process tracing is accomplished through the use of [bpftrace](https://github.com/iovisor/bpftrace), which leverages  capabilities provided by the enhanced Berkeley Packet Filter (*eBPF*).

## Requirements

- Linux kernel version >= 5.10
    - Compiled kernel should include the following flags:
    ```
    CONFIG_BPF=y
    CONFIG_BPF_SYSCALL=y
    CONFIG_BPF_JIT=y
    CONFIG_HAVE_EBPF_JIT=y
    CONFIG_TRACEPOINTS=y
    CONFIG_BPF_LSM=y
    CONFIG_DEBUG_INFO=y
    CONFIG_DEBUG_INFO_BTF=y
    CONFIG_BPF_EVENTS=y
    ```
- bpftrace >= v0.13.1
- Python >= v3.8
    - Run `pip install -r requirements.txt` to install required Python modules.

## Design

![Overarching Design](https://github.com/JakeJazokas/AutomaticPoliciesForBPFContain/blob/main/Images/GeneralDesign.png?raw=true)

## Usage

### Tracing Subsystem

The tracing subsystem uses [bpftrace](https://github.com/iovisor/bpftrace) along with the script `traceSystemOperations.bt` and can be executed independently through the following command:
```
sudo bpftrace traceSystemOperations.bt <arg> > <traceFile>
```
- `<arg>` represents the name of the program you wish to trace.
- `<traceFile>` represents the path to the output (`.txt`) file that all traced operations will be logged to.
&nbsp;

### Translation Subsystem

The translation subsystem is implemented through the Python script `translateToPolicy.py` and is used to generate [BPFContain](https://github.com/willfindlay/bpfcontain-rs) security policies based on the output generated by the tracing subsystem. To run the translation subsystem, use the following command:
```
python translateToPolicy.py -c <traceFile> -o <policyFile> -p <program> -f <programPath>
```
- `<traceFile>` represents the path to the (`.txt`) trace file generated by the tracing subsystem.
- `<policyFile>` represents the path to the output (`.yml`) file that will contain the generated security policy.
- `<program>` is the name of the program that was traced by the tracing subsystem.
- `<programPath>` is the full path to the traced program.

The following command can be run to view the descriptions for each argument
```
python translateToPolicy.py --help
```

### Combined Execution

The file `policyGenerator.py` can be used to run both the tracing and translation programs.

First, make sure you're using a root shell, which can be accomplished via the following command:
```
sudo bash
```
Then, run the script using the following command:
```
python policyGenerator.py -c <traceFile> -o <policyFile> -p <program> -f <programPath> -t <traceTime>
```
- `<traceFile>` represents the name of the output (`.txt`) file that all traced operations are saved to.
- `<policyFile>` represents the name of the output (`.yml`) file that will contain the generated security policy.
- `<program>` is the name of the program to trace, and `<programPath>` is the full path to this program.
- `<traceTime>` is the time in seconds, representing how long the program will be traced for.

The following command can be run to view the descriptions for each argument
```
python policyGenerator.py --help
```

## Examples

### Files

- Tracing examples can be found in the [TraceLogs](https://github.com/JakeJazokas/AutomaticPoliciesForBPFContain/tree/main/TraceLogs) directory, all of which were generated with the `traceSystemOperations.bt` script.

- Examples of generated security policy can be found in the [Policies](https://github.com/JakeJazokas/AutomaticPoliciesForBPFContain/tree/main/Policies) directory.

### Commands
`translateToPolicy.py` example:
```
python translateToPolicy.py -c TraceLogs\bashCapture.txt -o Policies\bash.yml -p bash -f /usr/bin/bash
```

`policyGenerator.py` example:
```
python policyGenerator.py -c TraceLogs\bashCapture.txt -o Policies\bash.yml -p bash -f /usr/bin/bash -t 20
```

## Documentation

The reports created for this project are in the [Documents](https://github.com/JakeJazokas/AutomaticPoliciesForBPFContain/tree/main/Documents) directory. All generated images and diagrams are in the [Images](https://github.com/JakeJazokas/AutomaticPoliciesForBPFContain/tree/main/Images) directory.

## Todo

- Generation of networking traces and security policy rules.
- Create a variable argument for the `traceSystemOperations.bt` script that represents the max nested depth of directories. Currently hardcoded to 10.
- Add taint operations.